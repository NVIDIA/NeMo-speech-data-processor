processors_to_run: "0:"
workspace_dir: /mnt/md1/common_crawl/cc_sdp
workspace_dir_s: /mnt/md0/common_crawl/cc_sdp

processors:
  - _target_: sdp.processors.datasets.commoncrawl.CreateInitialManifestCC
    raw_data_dir: /mnt/md0/common_crawl/output/video_output2
    output_manifest_file: ${workspace_dir_s}/manifest0.json
    video_key: "source_video"
    text_key: "texts"
    id_key: "key"

  - _target_: sdp.processors.datasets.commoncrawl.ReadParquet
    raw_data_dir: /mnt/md0/common_crawl/output/video_output2
    output_manifest_file: ${workspace_dir_s}/manifest1.json
    output_video_key: video_url
    output_caption_key: caption_url
    id_key: key

  - _target_: sdp.processors.FfmpegConverts
    output_manifest_file: ${workspace_dir_s}/manifest2.json #${workspace_dir_s}/manifest_urls.json
    resampled_audio_dir: ${workspace_dir}/audio
    target_samplerate: 16000
    target_nchannels: 1
    input_file_key: "source_video"
    output_file_key: "source_audio"
    id_key: "key"

  - _target_: sdp.processors.GetAudioDuration
    output_manifest_file: ${workspace_dir_s}/manifest3.json
    audio_file_key: source_audio
    duration_key: duration

  - _target_: sdp.processors.PreserveByValue
    output_manifest_file: ${workspace_dir_s}/manifest4.json
    input_value_key: duration
    target_value: 0
    operator: gt

  - _target_: sdp.processors.datasets.commoncrawl.TxtToVtt
    output_manifest_file: ${workspace_dir_s}/manifest5.json
    vtt_files_dir: ${workspace_dir_s}/vtts
    id_key: "key"
    text_key: "texts"
    vtt_key: "vtt_filepath"

  - _target_: sdp.processors.datasets.commoncrawl.AllVttText 
    output_manifest_file: ${workspace_dir_s}/manifest6.json
    input_filepath_key: vtt_filepath
    output_text_key: vtt_text

  - _target_: sdp.processors.datasets.commoncrawl.TextLid
    output_manifest_file: ${workspace_dir_s}/manifest7.json
    input_text_key: vtt_text
    output_lang_key: text_lang
    device: cuda
    pretrained_model: "jb2k/bert-base-multilingual-cased-language-detection"
    drop_text_duplicates: True

  - _target_: sdp.processors.datasets.commoncrawl.Lang2Iso
    output_manifest_file: ${workspace_dir_s}/manifest8.json
    input_lang_key: text_lang
    output_lang_key: text_lang

  - _target_: sdp.processors.datasets.commoncrawl.AudioLid
    output_manifest_file: ${workspace_dir_s}/manifest9.json
    input_audio_key: source_audio
    output_lang_key: audio_lang
    device: cuda
    pretrained_model: "langid_ambernet"

  - _target_: sdp.processors.datasets.commoncrawl.SplitByVttSentence
    output_manifest_file: ${workspace_dir_s}/manifest10.json
    splited_audio_dir: ${workspace_dir_s}/splited/
    source_audio_key: source_audio
    target_audio_key: audio_filepath
    duration_key: duration
    text_key: text
    vtt_key: vtt_filepath
    proxy_keys: [audio_lang, text_lang, source_audio]
    duration_threshold: 10.0

  - _target_: sdp.processors.DropHighLowDuration
    output_manifest_file: ${workspace_dir_s}/manifest11.json
    high_duration_threshold: 60
    low_duration_threshold: 0.01

  - _target_: sdp.processors.KeepOnlySpecifiedFields
    output_manifest_file: ${workspace_dir_s}/manifest12.json
    fields_to_keep: ["audio_filepath", "duration", "text", "audio_lang", "text_lang", "source_audio"]

  - _target_: sdp.processors.datasets.commoncrawl.EvalBandwidth
    input_manifest_file: ${workspace_dir_s}/manifest5.json
    output_manifest_file: ${workspace_dir_s}/manifest5a.json
    input_file_key: source_audio
    bandwidth_key: bandwidth

  - _target_: sdp.processors.datasets.commoncrawl.GetSpecificFiles
    input_manifest_file: ${workspace_dir_s}/manifest6.json
    output_manifest_file: ${workspace_dir_s}/long_dev_test/manifest6.json
    input_file_key: source_audio
    path_to_copy: ${workspace_dir_s}/long_dev_test